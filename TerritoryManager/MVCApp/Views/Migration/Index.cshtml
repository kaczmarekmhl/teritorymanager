<div>
    <div class="button buttonIn">
        <a href="#" id="migration" class="withImage">
            <img src='~/Images/WindowsIcons/Light/appbar.refresh.svg'/> Run migration
        </a>
    </div>
    <div class="button buttonIn">
        <a href="#" id="cancel">Cancel</a>
    </div>
    <div class="spacer" />
    </div>


    <div id="ajaxLoader" style="display: none">
        <img src="~/Images/ajax-loader.gif">
    </div>
    <span id="progressMessage"></span>
    <div id="migrationError" class="warningMessage" style="display: none"></div>


@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function() {

            var migrationInProgress = false;
            var migrationCancelled = false;

            // Reference the auto-generated proxy for the hub.
            var migrationHub = $.connection.migrationHub;

            migrationHub.client.setProgressMessage = function(message) {
                $('#progressMessage').text(message);
            };

            migrationHub.client.migrationError = function(message) {
                $('#ajaxLoader').hide();
                $('#migrationError').text(message);
                $('#migrationError').show();
                $('#migration').removeClass("pressed");
                migrationInProgress = false;
            };

            migrationHub.client.migrationComplete = function(migrationCompleted) {

                if (migrationCompleted || migrationCancelled) {
                    $('#progressMessage').text("Migration completed or cancelled!");
                } else {
                    runMigration();
                }

                $('#ajaxLoader').hide();
                $('#migration').removeClass("pressed");
                migrationInProgress = false;
            };

            // Start the connection.
            $.connection.hub.start()
                .done(function() {
                    $('#migration')
                        .click(function(e) {

                            e.preventDefault();

                            if (migrationInProgress) {
                                return;
                            }

                            migrationCancelled = false;

                            runMigration();
                        });

                    $('#cancel')
                        .click(function (e) {
                            migrationCancelled = true;
                            alert('Canceling migration in progress...');
                        });
                });

            function runMigration() {
                migrationHub.server.migration();
                $('#ajaxLoader').show();
                $('#searchError').hide();
                $('#migration').addClass("pressed");
                migrationInProgress = true;
            }
        });
    </script>
}